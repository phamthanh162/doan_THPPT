    
    % Nội suy

    % 1. THU THẬP VÀ XỬ LÝ DỮ LIỆU ĐẦU VÀO
    
    try
        % str2num: chuyển chuỗi số cách nhau bằng dấu cách hoặc dấu phẩy thành vector
        x_data = str2num(app.NhpdliuxEditField.Value); 
        y_data = str2num(app.NhpdliuyEditField.Value);
        x_interp = app.NhpgitrcnnisuyEditField.Value;  % Giá trị cần nội suy
        phuong_phap = app.ChnphngphpnisuyDropDown.Value;
        
        if isempty(x_data) || isempty(y_data) || length(x_data) ~= length(y_data)
            uialert(app.UIFigure, 'Vui lòng nhập dữ liệu x và y hợp lệ (cùng kích thước).', 'Lỗi Dữ liệu');
            return;
        end
        n = length(x_data);
    catch ME
        uialert(app.UIFigure, ['Lỗi nhập liệu: ' ME.message], 'Lỗi Đầu vào');
        return;
    end


    
    % 2. KHỞI TẠO BIẾN KẾT QUẢ VÀ SYMBOLIC
    
    syms x;
    P_sym = 0;   


    
    % 3. THỰC HIỆN TÍNH TOÁN NỘI SUY
    
    if strcmp(phuong_phap, 'Lagrange') % PHƯƠNG PHÁP NỘI SUY LAGRANGE
        for i = 1:n
            L_i = 1;
            % Tính toán đa thức cơ sở Lagrange L_i(x)
            for j = 1:n
                if i ~= j
                    L_i = L_i * (x - x_data(j)) / (x_data(i) - x_data(j));
                end
            end
            P_sym = P_sym + y_data(i) * L_i; % Cộng dồn đa thức P(x) = sum(y_i * L_i(x))
        end
        
    elseif strcmp(phuong_phap, 'Newton') % PHƯƠNG PHÁP NỘI SUY NEWTON
        
        % Tính bảng sai phân chia
        F = zeros(n, n);
        F(:, 1) = y_data';
        
        for j = 2:n
            for i = j:n
                % Công thức sai phân chia: F[i, j] = (F[i, j-1] - F[i-1, j-1]) / (x_data[i] - x_data[i-j+1])
                F(i, j) = (F(i, j-1) - F(i-1, j-1)) / (x_data(i) - x_data(i-j+1));
            end
        end
        
        % Các hệ số Newton là các phần tử trên đường chéo chính của F: F(1, 1), F(2, 2), ..., F(n, n)
        coeffs = diag(F)'; 
        
        % Xây dựng đa thức nội suy Newton P(x)
        P_sym = coeffs(1); % Bắt đầu với f[x0]
        T = 1; % Tích số (x - x_i)
        
        for k = 2:n
            % Tích T = (x - x_0)(x - x_1)...(x - x_{k-2})
            T = T * (x - x_data(k-1)); 
            P_sym = P_sym + coeffs(k) * T;
        end
    else
        uialert(app.UIFigure, 'Phương pháp nội suy chưa được chọn hoặc không hợp lệ.', 'Lỗi Thuật toán');
        return;
    end


    
    % 4. XỬ LÝ VÀ HIỂN THỊ KẾT QUẢ
    
    % Rút gọn đa thức và làm đẹp về dạng thập phân
    P_sym_simplified = vpa(simplify(P_sym), 6); 
    
    % Chuyển đa thức về dạng hàm để tính giá trị số
    P_func = matlabFunction(P_sym);
    
    % Tính kết quả nội suy số tại x_interp
    y_interp = P_func(x_interp);
    
    % Hiển thị Đa thức
    app.KtquathcnisuyTextArea.Value = char(P_sym_simplified);
    
    % Hiển thị Kết quả số
    app.KtqunisuyEditField.Value = y_interp;
    


    % 5. VẼ ĐỒ THỊ     
    try
        % Tạo khoảng X để vẽ đồ thị 
        x_min = min(x_data) - 0.1 * (max(x_data) - min(x_data));
        x_max = max(x_data) + 0.1 * (max(x_data) - min(x_data));
        X_plot = linspace(x_min, x_max, 500); 
        Y_plot = P_func(X_plot);
        
        % Xóa đồ thị cũ và thiết lập lại
        cla(app.UIAxes2);
        
        % Vẽ Đa thức nội suy
        plot(app.UIAxes2, X_plot, Y_plot, 'b-', 'LineWidth', 1.5, 'DisplayName', 'Đa thức nội suy'); 
        hold(app.UIAxes2, 'on'); 
        
        % Vẽ Dữ liệu thực
        plot(app.UIAxes2, x_data, y_data, 'ro', 'MarkerSize', 8, 'MarkerFaceColor', 'r', 'DisplayName', 'Dữ liệu thực'); 
        
        % Đánh dấu giá trị cần nội suy
        plot(app.UIAxes2, x_interp, y_interp, 'gx', 'MarkerSize', 10, 'LineWidth', 2, 'DisplayName', 'Giá trị nội suy');
        
        % Thiết lập tiêu đề và nhãn
        title(app.UIAxes2, ['Nội suy ' phuong_phap ' P(x)']);
        xlabel(app.UIAxes2, 'X');
        ylabel(app.UIAxes2, 'Y');
        legend(app.UIAxes2, 'show', 'Location', 'best');
        grid(app.UIAxes2, 'on');
        hold(app.UIAxes2, 'off');
        
    catch ME_plot
        uialert(app.UIFigure, ['Lỗi khi vẽ đồ thị: ' ME_plot.message], 'Lỗi Đồ thị');
    end
